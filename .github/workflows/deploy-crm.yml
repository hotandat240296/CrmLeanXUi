name: Deploy API Only

on:
  push:
    branches:
      - main
    paths:
      - 'CrmLeanXUi/**'
      - 'helm-charts/crm-web/**'
      - 'Dockerfile'
      - '.github/workflows/deploy-crm.yml'
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      deploy_namespace:
        description: 'Namespace to deploy to'
        required: true
        default: 'idea-production'
        type: choice
        options:
        - idea-production
        - idea-staging
      version_increment:
        description: 'Version to use (e.g., v1.0.1 or 1.0.1 or just 1 for patch, empty for auto-increment)'
        required: false
        default: ''
        type: string

permissions:
  contents: write
  packages: write

env:
  DOCKER_REGISTRY: docker.io
  TOKEN_IMAGE_NAME: tandat240206/crm-web
  TOKEN_HELM_CHART_PATH: helm-charts/crm-web
  VERSION_MAJOR: 1
  VERSION_MINOR: 0

jobs:
  build-and-push-token:
    name: Build and Push API Docker Image
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.determine-tag.outputs.tag }}
      version-tag: ${{ steps.determine-tag.outputs.version_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version and tags
        id: determine-tag
        run: |
          VERSION_PREFIX="v${{ env.VERSION_MAJOR }}.${{ env.VERSION_MINOR }}"
          LATEST_TAG=$(git tag -l "${VERSION_PREFIX}.*" | sort -V | tail -n 1)
          
          if [ -z "$LATEST_TAG" ]; then
            PATCH=0
          else
            PATCH=$(echo "$LATEST_TAG" | sed "s|${VERSION_PREFIX}.||")
            PATCH=$((PATCH + 1))
          fi
          
          INPUT_VERSION="${{ github.event.inputs.version_increment }}"
          if [ -n "$INPUT_VERSION" ]; then
            INPUT_VERSION="${INPUT_VERSION#v}"
            if [[ "$INPUT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              VERSION_TAG="v${INPUT_VERSION}"
            elif [[ "$INPUT_VERSION" =~ ^[0-9]+$ ]]; then
              PATCH=$INPUT_VERSION
              VERSION_TAG="${VERSION_PREFIX}.${PATCH}"
            else
              VERSION_TAG="${VERSION_PREFIX}.${PATCH}"
            fi
          else
            VERSION_TAG="${VERSION_PREFIX}.${PATCH}"
          fi
          
          SHA_TAG=$(echo ${{ github.sha }} | cut -c1-7)
          
          echo "tag=sha-${SHA_TAG}" >> $GITHUB_OUTPUT
          echo "version_tag=${VERSION_TAG}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push CRM Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: CrmLeanXUi/Dockerfile
          push: true
          tags: |
            ${{ env.TOKEN_IMAGE_NAME }}:${{ steps.determine-tag.outputs.version_tag }}
            ${{ env.TOKEN_IMAGE_NAME }}:sha-${{ github.sha }}
            ${{ env.TOKEN_IMAGE_NAME }}:latest
          cache-from: type=gha,scope=token
          cache-to: type=gha,mode=max,scope=token
          platforms: linux/amd64

      - name: Create Git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          VERSION_TAG="${{ steps.determine-tag.outputs.version_tag }}"
          
          if git rev-parse "$VERSION_TAG" >/dev/null 2>&1; then
            echo "Tag exists, skip"
          else
            git tag -a "$VERSION_TAG" -m "Release $VERSION_TAG"
            git push origin "$VERSION_TAG"
          fi

  deploy-token:
    name: Deploy CRM to Kubernetes
    needs: [build-and-push-token]
    runs-on: ubuntu-latest
    if: always() && (needs.build-and-push-token.result == 'success' || needs.build-and-push-token.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure Kubernetes
        uses: azure/k8s-set-context@v3
        with:
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: Determine image tag for deployment
        id: image-tag
        run: |
          echo "tag=${{ needs.build-and-push-token.outputs.version-tag }}" >> $GITHUB_OUTPUT

      - name: Deploy CRM to Kubernetes
        run: |
          ENVIRONMENT="${{ github.event.inputs.deploy_environment || 'production' }}"
          NAMESPACE="${{ github.event.inputs.deploy_namespace || 'idea-production' }}"
          IMAGE_TAG="${{ steps.image-tag.outputs.tag }}"
          
          echo "Deploying: env=$ENVIRONMENT namespace=$NAMESPACE tag=$IMAGE_TAG"

          if [ "$ENVIRONMENT" = "production" ]; then
            echo "Using production values-prod.yaml"

            helm upgrade --install crm-web ${{ env.TOKEN_HELM_CHART_PATH }} \
              --set image.tag=$IMAGE_TAG \
              --set namespace=$NAMESPACE \
              --namespace $NAMESPACE \
              -f ${{ env.TOKEN_HELM_CHART_PATH }}/values-prod.yaml \
              --create-namespace \
              --wait \
              --timeout=10m
          else
            echo "Using default values"
            helm upgrade --install crm-web ${{ env.TOKEN_HELM_CHART_PATH }} \
              --set image.tag=$IMAGE_TAG \
              --set namespace=$NAMESPACE \
              --namespace $NAMESPACE \
              --create-namespace \
              --wait \
              --timeout=10m
          fi

      - name: Verify deployment
        run: |
          NAMESPACE="${{ github.event.inputs.deploy_namespace || 'idea-production' }}"
          kubectl get pods -n $NAMESPACE -l app.kubernetes.io/name=crm-web
          kubectl get services -n $NAMESPACE -l app.kubernetes.io/name=crm-web
          kubectl get ingress -n $NAMESPACE -l app.kubernetes.io/name=crm-web

      - name: Health check
        run: |
          sleep 60
          RESPONSE=$(curl -s --max-time 15 https://crm.web.iotsystems-vn.com/health || echo "")
          if echo "$RESPONSE" | jq -e '.status=="Healthy"' >/dev/null; then
            echo "TOKEN_HEALTH=healthy" >> $GITHUB_ENV
          else
            echo "TOKEN_HEALTH=unhealthy" >> $GITHUB_ENV
          fi

      - name: Generate summary
        run: |
          ENVIRONMENT="${{ github.event.inputs.deploy_environment || 'production' }}"
          NAMESPACE="${{ github.event.inputs.deploy_namespace || 'idea-production' }}"
          echo "## Token Deployment Summary ðŸŽ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: $NAMESPACE" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.build-and-push-token.outputs.version-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: ${{ steps.image-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image**: ${{ env.TOKEN_IMAGE_NAME }}:${{ needs.build-and-push-token.outputs.version-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://crm.web.iotsystems-vn.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Status**: ${{ env.TOKEN_HEALTH }}" >> $GITHUB_STEP_SUMMARY
